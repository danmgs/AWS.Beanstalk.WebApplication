# AWS.Beanstalk.WebApplication
A demo web application in .NET Core for AWS Elastic Beanstalk. It is leveraging AWS DynamoDB and X-Ray services.

## 1. Prerequisites

### 1.1 EC2 Profile

Your elasticbeanstalk environment will have EC2 instance(s) which require the following role setup :
- the default elasticbeanstalk role generated by AWS extended with additionnal:

    * **SSM Role (optional)** to log into EC2 via AWS Session manager console for debug. So, there's no need to attach the EC2 any keypair and any security group with RDP ingress rule.
    * Custom inline policy **"MyCustomPolicy" (mandatory)** for DynamoDB, X-Ray, SNS operations defined as below:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "CustomPolicy",
            "Effect": "Allow",
            "Action": [                
                "sns:Publish",                
                "dynamodb:PutItem",
                "dynamodb:DescribeTable",
                "dynamodb:DeleteItem",                
                "dynamodb:GetItem",
                "dynamodb:Scan",
                "dynamodb:UpdateItem",
                "xray:GetSamplingStatisticSummaries",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:PutTraceSegments"
            ],
            "Resource": "*"
        }
    ]
}
```
EC2 profile should look like :

![alt capture](https://github.com/danmgs/AWS.Beanstalk.WebApplication/blob/master/img/configure_ec2_profile.PNG)

## 2. Getting started

- Run the script **AWS.Beanstalk.WebApplication\scripts\pack.bat** to generate the application file **bundle.zip** in the **output** directory.
This bundle contains :<br>
    * the application binaries
    * .ebextensions configuration files allowing:
        * custom [environment variables](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-softwaresettings.html) (in [ElasticBeanstalk console](https://console.aws.amazon.com/elasticbeanstalk): **Configuration > Software > Environment properties**)
        * elasticbeanstalk configuration, 
        * aws resources such as Dynamodb **"Product"** table, 
        * X-Ray daemon setup ... etc 
	* a [manifest](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/dotnet-manifest.html) **aws-windows-deployment-manifest.json** describing the deployment in IIS

- Under [ElasticBeanstalk console](https://console.aws.amazon.com/elasticbeanstalk), create an application then its environment with selected platform **.NET (Windows/IIS)** and upload the **bundle.zip** file.

- Once the environment is created, browse the website
    * play with the product page. Product items will be stored and retrieved from generated **Product** dynamoDB table.
    * check the [X-Ray console](https://aws.amazon.com/xray) for insights.

    Service map in X-Ray:

    ![alt capture](https://github.com/danmgs/AWS.Beanstalk.WebApplication/blob/master/img/xray_service_map.PNG)

## 3. Useful resources

- [Set environment properties](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-softwaresettings.html)

- [Config samples](https://github.com/awsdocs/elastic-beanstalk-samples/tree/master/configuration-files/aws-provided/instance-configuration)

## 4. Some useful commands when connected into EC2

```bash
  # View application custom logs
    cat C:\logs\xray-sdk.log
    cat C:\logs\webapp.log    
    cat C:\logs\all.log
```

```bash
  # List all started services in windows
    net start
```

```bash
  # Stop and start any service: net stop/start servicename
    net stop "AWS X-Ray"
    net start "AWS X-Ray"
```

```bash
  # Restart IIS
    iisreset
```