# AWS.Beanstalk.WebApplication
A demo web application in .NET Core for AWS Elastic Beanstalk. It is leveraging AWS DynamoDB and X-Ray services.

## 1. Prerequisites

### 1.1 EC2 Profile

Your elasticbeanstalk environment will have EC2 instance(s) which require the following role setup :
- the default elasticbeanstalk role generated by AWS extended with additionnal:

    * **SSM Role (optional)** to log into EC2 via AWS Session manager console for debug. So, there's no need to attach the EC2 any keypair and any security group with RDP ingress rule.
    * Custom inline policy **"MyCustomPolicy" (mandatory)** for DynamoDB, X-Ray, SNS operations defined as below:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "CustomPolicy",
            "Effect": "Allow",
            "Action": [                
                "sns:Publish",                
                "dynamodb:PutItem",
                "dynamodb:DescribeTable",
                "dynamodb:DeleteItem",                
                "dynamodb:GetItem",
                "dynamodb:Scan",
                "dynamodb:UpdateItem",
                "xray:GetSamplingStatisticSummaries",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets",
                "xray:PutTraceSegments"
            ],
            "Resource": "*"
        }
    ]
}
```
EC2 profile should look like :

![alt capture](https://github.com/danmgs/AWS.Beanstalk.WebApplication/blob/master/img/configure_ec2_profile.PNG)

### 1.2 Setup the eb-cli and configure

- You must install the [eb-cli](https://docs.aws.amazon.com/fr_fr/elasticbeanstalk/latest/dg/eb-cli3-install-windows.html) in order to deploy.

- Configure the deployment:<br>
There is already a configuration file under the directory **AWS.Beanstalk.WebApplication\scripts\deploy\\.elasticbeanstalk\\**, however you can replace with a new one with command:

```
eb init
```

This will create the application in Elasticbeanstalk console.

- You can create the aplication and its environment with the cli but I prefer doing it via console. <br>
Under [ElasticBeanstalk console](https://console.aws.amazon.com/elasticbeanstalk), create an application then its environment with selected platform **.NET (Windows/IIS)**.

## 2. Getting started

- In directory **AWS.Beanstalk.WebApplication\scripts**, run the script **pack.bat** to build the application. This will generate into the **output** directory.

- In directory **AWS.Beanstalk.WebApplication\scripts**, run the script **deploy.bat** to deploy the application. This will generate a bundle zip file into the **deploy** directory. The bundle will be deployed to your elasticbeanstalk environment, by leveraging the **eb deploy** command with your Elasticbeanstalk configuration.

The bundle uploaded contains :<br>
    * the application binaries
    * .ebextensions configuration files allowing:
        * custom [environment variables](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-softwaresettings.html) (in [ElasticBeanstalk console](https://console.aws.amazon.com/elasticbeanstalk): **Configuration > Software > Environment properties**)
        * elasticbeanstalk configuration, 
        * aws resources such as Dynamodb **"Product"** table, 
        * X-Ray daemon setup ... etc 
	* a [manifest](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/dotnet-manifest.html) **aws-windows-deployment-manifest.json** describing the deployment in IIS

- Once the environment is created, browse the website
    * play with the product page. Product items will be stored and retrieved from generated **Product** dynamoDB table.
    * check the [X-Ray console](https://aws.amazon.com/xray) for insights.<br>
    You can filter traces on annotations via the search bar, by example:

    ```
    # filter on create product operation
    annotation.operationType="CreateProduct"

    # filter on all type of operations with product
    annotation.operationType CONTAINS "Product"
    ```

    Service map in X-Ray:

    ![alt capture](https://github.com/danmgs/AWS.Beanstalk.WebApplication/blob/master/img/xray_service_map.PNG)

## 3. Useful resources

- [Set environment properties](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-softwaresettings.html)

- [Config samples](https://github.com/awsdocs/elastic-beanstalk-samples/tree/master/configuration-files/aws-provided/instance-configuration)

## 4. Some useful commands when connected into EC2

```bash
  # View application custom logs
    cat C:\logs\xray-sdk.log
    cat C:\logs\webapp.log    
    cat C:\logs\all.log
```

```bash
  # List all started services in windows
    net start
```

```bash
  # Stop and start any service: net stop/start servicename
    net stop "AWS X-Ray"
    net start "AWS X-Ray"
```

```bash
  # Restart IIS
    iisreset
```